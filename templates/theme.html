<?python
from genshi.builder import tag
from genshi.core import QName

TRIM_SIZE = 23
SIDEBAR_SPAN = 3
CONTENT_SPAN = 12 - SIDEBAR_SPAN

first_metanav = chrome['nav']['metanav'][0]['label']
if hasattr(first_metanav, 'children'):
  user_menu_text = first_metanav.children
else:
  user_menu_text = first_metanav

new_ctxtnav = []
for element in chrome['ctxtnav']:
  if hasattr(element, 'attrib'):
    element.attrib = element.attrib | [(QName('class'), 'btn')]
  else:
    element = tag.a(element,  class_='btn disabled')
  new_ctxtnav.append(element)
chrome['ctxtnav'] = new_ctxtnav

db = perm.env.get_db_cnx()
cursor = db.cursor()
cursor.execute(
  "SELECT id, title FROM report ORDER BY %s" % ('id'))
all_reports = list(cursor)

sql = (
  'SELECT name, max(time) AS max_time FROM wiki '
  'GROUP BY name ORDER BY max_time DESC LIMIT 15'
  )
cursor.execute(sql)
last_wikis = list(cursor)

?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:i18n="http://genshi.edgewall.org/i18n"
      py:strip="">

  <!--! Add site-specific style sheet -->
  <head py:match="head" py:attrs="select('@*')">
    ${select('*|comment()|text()')}
    <link rel="stylesheet" type="text/css"
          href="${href.chrome('site/css/bootstrap.css')}" />
    <link rel="stylesheet" type="text/css"
          href="${href.chrome('site/css/patch.css')}" />
    <link rel="stylesheet" type="text/css"
          href="${href.chrome('site/css/bootstrap-responsive.css')}" />
  </head>

  <py:match path="body" once="true" buffer="false">
    <body>
    <div class="navbar navbar-default navbar-inverse navbar-fixed-top">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="${req.base_url}">${project.name}</a>
      </div>

      <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <i class="icon-user"></i> ${user_menu_text} <b class="caret"></b>
            </a>
            <ul class="dropdown-menu" py:if="chrome.nav['metanav']">
              <li py:for="idx, item in  enumerate(chrome.nav['metanav'])"
                  class="${classes(first_last(idx, chrome.nav['metanav']), active=item.active)}">
                  ${item.label}
              </li>
            </ul>
          </li>
        </ul>

        <ul class="nav navbar-nav navbar-left" py:if="chrome.nav['mainnav']">
          <li py:for="idx, item in enumerate(chrome.nav['mainnav'])"
              class="${classes(first_last(idx, chrome.nav['mainnav']), active=item.active)}">${item.label}</li>
        </ul>

        <form id="search" class="navbar-form navbar-right" action="${href.search()}" method="get" role="search">
          <py:if test="not defined('trac_error_rendering') and 'SEARCH_VIEW' in perm">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Quick search" id="proj-search" name="q" size="18" accesskey="f" value=""/>
            </div>
          </py:if>
        </form>
      </div>
    </div>

    <div id="main" class="container">
      <div class="row">
        <div class="col-md-${SIDEBAR_SPAN}">
          <div class="list-group">
            <div class="list-group-item"><h4 class="list-group-item-heading">Actions</h4></div>
            <a href="${href.newticket()}?type=task" class="list-group-item">Add task</a>
            <a href="${href.newticket()}?type=bug" class="list-group-item">Add bug</a>
            <div class="list-group-item"><h4 class="list-group-item-heading">Tickets</h4></div>
            <div py:for="report in all_reports">
              <a href="${href.report(report[0])}" class="list-group-item">${report[1]}</a>
            </div>
            <div class="list-group-item"><h4 class="list-group-item-heading">Last modified pages</h4></div>
            <a href="${href.wiki('TitleIndex')}" class="list-group-item">Title Index</a>
            <div py:for="wiki_page in last_wikis">
              <a href="${href.wiki(wiki_page[0])}" class="list-group-item">
                  <py:if test="len(wiki_page[0]) &lt; TRIM_SIZE + 1">
                    ${wiki_page[0]}
                  </py:if>
                  <py:if test="len(wiki_page[0]) &gt; TRIM_SIZE">
                    <py:with vars="short_name=wiki_page[0][-22:]">
                      ...${short_name}
                    </py:with>
                  </py:if>
              </a>
            </div>
          </div>

        </div>
        <div class="col-md-${CONTENT_SPAN}">
          <div class="row">
            <div class="col-md-6">
              <xi:include py:if="value_of('resourcepath_template')" href="${resourcepath_template}" />
            </div>
            <div class="col-md-6">
              <div id="ctxtnav" class="btn-group pull-right" py:if="chrome.ctxtnav">
                      <a py:if="req.environ['PATH_INFO'].startswith('/wiki')" class="btn" href="${req.href(req.path_info)}?action=edit">
                        Edit page
                      </a>
                    <py:for each="i, elm in enumerate(chrome.ctxtnav)" class="btn">$elm</py:for>
              </div>
            </div>
          </div>
          <div class="row" py:if="chrome.warnings and chrome.notices">
            <div class="col-md-12">
              <div id="warning" py:if="chrome.warnings" class="system-message">
                <py:choose test="len(chrome.warnings)">
                  <strong>Warning:</strong>
                  <py:when test="1">${chrome.warnings[0]}</py:when>
                  <py:otherwise><ul><li py:for="warning in chrome.warnings">$warning</li></ul></py:otherwise>
                </py:choose>
              </div>
              <div id="notice" py:if="chrome.notices" class="system-message">
                <py:choose test="len(chrome.notices)">
                  <py:when test="1">${chrome.notices[0]}</py:when>
                  <py:otherwise><ul><li py:for="notice in chrome.notices">$notice</li></ul></py:otherwise>
                </py:choose>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              ${select('*|comment()|text()')}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="footer" xml:lang="en"><hr/>
      <a id="tracpowered" href="http://trac.edgewall.org/"><img
        src="${chrome.htdocs_location}trac_logo_mini.png" height="30"
        width="107" alt="Trac Powered" class="pull-left" /></a>
      <p class="pull-left" i18n:msg="version">
        Powered by <a href="${href.about()}"><strong>Trac ${trac.version}</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.
      </p>
      <p class="pull-right">${chrome.footer}</p>
    </div>

    <!-- Put script at the end for faster loading. -->
    <script src="${href.chrome('site/js/jquery.min.js')}"></script>
    <script src="${href.chrome('site/js/bootstrap.min.js')}"></script>

  </body>
  </py:match>
</html>
